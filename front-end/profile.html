<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profile - MRT App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
</head>
<body class="min-h-screen bg-gradient-to-br from-cyan-100 to-blue-200 flex items-center justify-center relative">

  <!-- Background -->
  <div class="absolute inset-0 bg-[url('image/bdFlag.png')] bg-cover bg-center opacity-20 z-0"></div>

  <!-- Profile Card -->
  <div class="relative z-10 bg-white bg-opacity-95 p-10 rounded-2xl shadow-2xl w-full max-w-2xl">
    <!-- Close Button -->
    <button onclick="window.location.href='/front-end/dashbroad.html'" class="absolute top-4 right-4 text-gray-600 hover:text-red-500 text-2xl">
      <i class="fas fa-times"></i>
    </button>

    <h2 class="text-3xl font-bold text-[#006a4e] mb-6">Your Profile</h2>

    <!-- Profile Form -->
    <form id="profileForm" class="space-y-6">
      <!-- Username -->
      <div>
        <label class="block text-lg font-semibold text-[#006a4e] mb-1">Username</label>
        <input type="text" id="username" class="w-full px-4 py-2 border rounded-md bg-gray-100 text-gray-600 cursor-not-allowed" readonly />
      </div>

      <!-- NID -->
      <div>
        <label class="block text-lg font-semibold text-[#006a4e] mb-1">NID Number</label>
        <input type="text" id="nid" class="w-full px-4 py-2 border rounded-md bg-gray-100 text-gray-600 cursor-not-allowed" readonly />
      </div>

      <!-- Email -->
      <div>
        <label class="block text-lg font-semibold text-[#006a4e] mb-1">Email Address</label>
        <input type="email" id="email" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-[#006a4e]" required />
        <p class="text-sm text-red-500 mt-1">üì¢ Email must be added and valid</p>
      </div>

      <!-- Phone -->
      <div>
        <label class="block text-lg font-semibold text-[#006a4e] mb-1">Phone Number</label>
        <input type="tel" id="phone" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-[#006a4e]" required />
      </div>

      <button type="submit" class="w-full bg-[#f42a41] text-white py-3 rounded-md hover:bg-red-600 font-bold transition">
        Save Changes
      </button>
    </form>
  </div>

  <script>
    async function fetchUserProfile() {
      const token = localStorage.getItem("token");
      if (!token) {
        alert("‚ö†Ô∏è Please login first.");
        return window.location.href = "/front-end/login.html";
      }

      try {
        const res = await fetch("http://localhost:3000/api/auth/me", {
          headers: { Authorization: "Bearer " + token }
        });

        if (!res.ok) throw new Error("Failed to fetch user");

        const user = await res.json();

        document.getElementById("username").value = user.username || "";
        document.getElementById("nid").value = user.nid || "";
        document.getElementById("email").value = user.email || "";
        document.getElementById("phone").value = user.phone || "";
      } catch (err) {
        alert("‚ùå Error loading profile: " + err.message);
        localStorage.removeItem("token");
        window.location.href = "/front-end/login.html";
      }
    }

    document.addEventListener("DOMContentLoaded", fetchUserProfile);

    document.getElementById("profileForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const email = document.getElementById("email").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const token = localStorage.getItem("token");

      if (!token) {
        alert("‚ö†Ô∏è Please login again.");
        return window.location.href = "/front-end/login.html";
      }

      if (!email || !phone) {
        alert("‚ö†Ô∏è Email and phone are required.");
        return;
      }

      // Simple email regex check
      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailPattern.test(email)) {
        alert("‚ö†Ô∏è Please enter a valid email address.");
        return;
      }

      // Simple phone regex (digits only, 10-15 length)
      const phonePattern = /^[0-9]{10,15}$/;
      if (!phonePattern.test(phone)) {
        alert("‚ö†Ô∏è Please enter a valid phone number (10-15 digits).");
        return;
      }

      try {
        const submitBtn = e.target.querySelector("button[type='submit']");
        submitBtn.disabled = true;
        submitBtn.textContent = "Saving...";

        // Update phone
        const phoneRes = await fetch("http://localhost:3000/api/auth/update-phone", {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token
          },
          body: JSON.stringify({ phone })
        });

        if (!phoneRes.ok) {
          if (phoneRes.status === 401) {
            alert("Session expired. Please login again.");
            localStorage.removeItem("token");
            return window.location.href = "/front-end/login.html";
          }
          const err = await phoneRes.json();
          throw new Error(err.msg || "Failed to update phone");
        }

        // Update email
        const emailRes = await fetch("http://localhost:3000/api/auth/update-email", {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token
          },
          body: JSON.stringify({ email })
        });

        if (!emailRes.ok) {
          if (emailRes.status === 401) {
            alert("Session expired. Please login again.");
            localStorage.removeItem("token");
            return window.location.href = "/front-end/login.html";
          }
          const err = await emailRes.json();
          throw new Error(err.msg || "Failed to update email");
        }

        alert("‚úÖ Profile updated successfully!");
      } catch (err) {
        alert("‚ùå Update failed: " + err.message);
      } finally {
        const submitBtn = e.target.querySelector("button[type='submit']");
        submitBtn.disabled = false;
        submitBtn.textContent = "Save Changes";
      }
    });
  </script>
</body>
</html>
