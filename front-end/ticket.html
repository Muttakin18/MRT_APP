<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Book Your MRT</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <style>
    /* Add your scrolling animation for the notice */
    @keyframes scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
    .animate-scroll {
      display: inline-block;
      white-space: nowrap;
      animation: scroll 10s linear infinite;
    }
  </style>
</head>
<body class="bg-gradient-to-b from-red-50 to-green-300">

  <!-- ðŸ“ Ticket Section -->
  <div id="ticketSection" class="mt-16 px-6">

    <!-- âŒ Close Button -->
    <div class="flex justify-end mb-4">
      <button onclick="window.location.href='/front-end/dashbroad.html'" class="text-3xl text-red-600 hover:text-red-800 font-bold">&times;</button>
    </div>

    <div class="w-full max-w-6xl px-6 py-10 bg-white/80 backdrop-blur-md border border-green-300 shadow-2xl rounded-3xl mx-auto">
      <h2 class="text-4xl font-extrabold text-center text-green-700 mb-10 drop-shadow-md">ðŸŽ« MRT Trip Booking</h2>

      <!-- Scrolling Notice -->
      <div class="overflow-hidden bg-yellow-200 border border-yellow-400 rounded-xl mb-8">
        <div class="whitespace-nowrap animate-scroll text-red-700 text-2xl font-bold px-4 py-3">
          CHILDREN ABOVE 3FT NEED TICKET! &nbsp;&nbsp;&nbsp; CHILDREN ABOVE 3FT NEED TICKET! &nbsp;&nbsp;&nbsp;
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Left Form -->
        <div class="space-y-6">
          <div>
            <label class="block font-semibold text-gray-700 mb-2 text-xl">Starting Point</label>
            <select id="startPoint" class="w-full border border-green-300 rounded-xl px-4 py-3 shadow">
              <option>Uttara North</option>
              <option>Uttara Center</option>
              <option>Uttara South</option>
              <option>Pallabi</option>
              <option>Mirpur-11</option>
              <option>Mirpur-10</option>
              <option>Kazipara</option>
              <option>Shewrapara</option>
              <option>Agargaon</option>
              <option>Bijoy Sarani</option>
              <option>Farmgate</option>
              <option>Karwan Bazar</option>
              <option>Shahbagh</option>
              <option>Dhaka University</option>
              <option>Bangladesh Secretariat</option>
              <option>Motijheel</option>
            </select>
          </div>
          <div>
            <label class="block font-semibold text-gray-700 mb-2 text-xl">Destination</label>
            <select id="endPoint" class="w-full border border-green-300 rounded-xl px-4 py-3 shadow">
              <option>Uttara North</option>
              <option>Uttara Center</option>
              <option>Uttara South</option>
              <option>Pallabi</option>
              <option>Mirpur-11</option>
              <option>Mirpur-10</option>
              <option>Kazipara</option>
              <option>Shewrapara</option>
              <option>Agargaon</option>
              <option>Bijoy Sarani</option>
              <option>Farmgate</option>
              <option>Karwan Bazar</option>
              <option>Shahbagh</option>
              <option>Dhaka University</option>
              <option>Bangladesh Secretariat</option>
              <option>Motijheel</option>
            </select>
          </div>
          <div>
            <label class="block font-semibold text-gray-700 mb-2 text-xl">Select Date</label>
            <input type="date" id="tripDate" class="w-full border border-green-300 rounded-xl px-4 py-3 shadow" />
          </div>
        </div>

        <!-- Right Form -->
        <div class="space-y-6">
          <div>
            <label class="block font-semibold text-gray-700 mb-2 text-xl">Select Time</label>
            <select id="tripTime" class="w-full border border-green-300 rounded-xl px-4 py-3 shadow"></select>
          </div>
          <div>
            <label class="block font-semibold text-gray-700 mb-2 text-xl">Trip Type</label>
            <select id="tripType" class="w-full border border-green-300 rounded-xl px-4 py-3 shadow">
              <option>Single</option>
              <option>Round</option>
            </select>
          </div>
          <div class="flex gap-4">
            <div class="w-1/2">
              <label class="block font-semibold text-gray-700 mb-2 text-xl">Adults</label>
              <input type="number" id="adultCount" min="1" max="10" class="w-full border border-green-300 rounded-xl px-4 py-3" />
            </div>
            <div class="w-1/2">
              <label class="block font-semibold text-gray-700 mb-2 text-xl">Children (&lt;3 yrs)</label>
              <input type="number" id="childCount" min="0" max="5" class="w-full border border-green-300 rounded-xl px-4 py-3" />
            </div>
          </div>
        </div>
      </div>

      <!-- Confirm Button -->
      <div class="mt-10 text-center">
        <button onclick="confirmTrip()" class="bg-green-600 hover:bg-green-800 text-white font-bold px-10 py-4 text-xl rounded-xl">Confirm Trip</button>
      </div>

      <!-- Trip Summary -->
      <div id="tripOutput" class="mt-12 hidden bg-white border border-green-400 rounded-xl p-8">
        <div class="flex justify-end">
          <button onclick="document.getElementById('tripOutput').classList.add('hidden')" class="text-3xl text-red-600 hover:text-red-800 font-bold">&times;</button>
        </div>

        <h3 class="text-4xl font-bold text-green-700 mb-4">ðŸ§¾ Trip Summary</h3>
        <div id="summaryContent" class="text-gray-800 text-2xl space-y-2"></div>
        <div id="qrcode" class="mt-6 flex justify-center"></div>
        <p class="text-center text-2xl text-gray-500 mt-2">ðŸ“± Scan this code at entry and exit points</p>

        <!-- Pay Now Button -->
        <div class="mt-6 text-center">
          <button onclick="payNow()" class="bg-[#f42a41] hover:bg-red-700 text-white font-bold px-10 py-4 text-xl rounded-xl shadow-lg">Pay Now</button>
        </div>
      </div>
    </div>
  </div>

<script>
  function setMinDate() {
    const dateInput = document.getElementById('tripDate');
    const today = new Date();
    const formattedToday = today.toISOString().split("T")[0];
    dateInput.min = formattedToday;
    if (!dateInput.value || dateInput.value < formattedToday) {
      dateInput.value = formattedToday;
    }
  }

  function populateTimeOptions() {
  const dateInput = document.getElementById('tripDate');
  const timeSelect = document.getElementById('tripTime');
  const selectedDate = dateInput.value;
  const now = new Date();
  const todayStr = now.toISOString().split("T")[0];

  timeSelect.innerHTML = "";
  timeSelect.disabled = false;

  // If no date selected, set to today
  if (!selectedDate) {
    dateInput.value = todayStr;
  }

  // If selected date is today but time is after 9:50 PM, disable time selection
  const isLateToday = selectedDate === todayStr && (now.getHours() > 21 || (now.getHours() === 21 && now.getMinutes() >= 50));
  if (isLateToday) {
    timeSelect.innerHTML = '<option disabled selected>No trips available after 9:50 PM</option>';
    timeSelect.disabled = true;
    return;
  }

  let closestOption = null;
  let minDiff = Infinity;

  for (let h = 7; h <= 21; h++) {
    for (let m = 0; m < 60; m += 10) {
      const optionTime = new Date(selectedDate + "T" + String(h).padStart(2, '0') + ":" + String(m).padStart(2, '0') + ":00");

      const hour12 = h % 12 === 0 ? 12 : h % 12;
      const ampm = h < 12 ? "AM" : "PM";
      const label = `${hour12}:${m.toString().padStart(2, "0")} ${ampm}`;

      const option = document.createElement("option");
      option.textContent = label;
      option.value = label;

      if (selectedDate === todayStr && optionTime < now) {
        // Disable times already passed today
        option.disabled = true;
      }

      timeSelect.appendChild(option);

      // Find closest upcoming time only if today
      if (selectedDate === todayStr && !option.disabled) {
        const diff = optionTime - now;
        if (diff >= 0 && diff < minDiff) {
          minDiff = diff;
          closestOption = option;
        }
      }
    }
  }

  // Set default selected time
  if (selectedDate === todayStr && closestOption) {
    timeSelect.value = closestOption.value;
  } else {
    // For future date, select first enabled option (7:00 AM)
    for (let i = 0; i < timeSelect.options.length; i++) {
      if (!timeSelect.options[i].disabled) {
        timeSelect.selectedIndex = i;
        break;
      }
    }
  }
}


  function calculateAccurateFare(from, to, hasPass) {
    const stations = [
      "Uttara North", "Uttara Center", "Uttara South", "Pallabi", "Mirpur-11", "Mirpur-10",
      "Kazipara", "Shewrapara", "Agargaon", "Bijoy Sarani", "Farmgate", "Karwan Bazar",
      "Shahbagh", "Dhaka University", "Bangladesh Secretariat", "Motijheel"
    ];
    const distances = [1.1, 1.2, 1.3, 1.0, 1.1, 1.0, 1.0, 1.2, 1.5, 1.0, 0.9, 1.0, 0.8, 1.1, 1.2];
    const fromIndex = stations.indexOf(from);
    const toIndex = stations.indexOf(to);
    if (fromIndex === -1 || toIndex === -1 || fromIndex === toIndex) return null;
    const start = Math.min(fromIndex, toIndex);
    const end = Math.max(fromIndex, toIndex);
    let distance = 0;
    for (let i = start; i < end; i++) distance += distances[i];
    let fare = distance <= 2 ? 20 : 20 + (distance - 2) * 5;
    if (hasPass) fare *= 0.9;
    return Math.round(fare / 10) * 10;
  }

  async function confirmTrip() {
    const confirmBtn = document.querySelector('button[onclick="confirmTrip()"]');
    confirmBtn.disabled = true;
    confirmBtn.textContent = "Processing...";

    const from = document.getElementById('startPoint').value;
    const to = document.getElementById('endPoint').value;
    const date = document.getElementById('tripDate').value;
    const time = document.getElementById('tripTime').value;
    const type = document.getElementById('tripType').value;
    const adults = parseInt(document.getElementById('adultCount').value) || 0;
    const children = parseInt(document.getElementById('childCount').value) || 0;
    const hasPass = true;

    if (adults === 0 && children === 0) {
      alert("Please enter at least one passenger.");
      confirmBtn.disabled = false;
      confirmBtn.textContent = "Confirm Trip";
      return;
    }

    const baseFare = calculateAccurateFare(from, to, hasPass);
    if (baseFare === null) {
      alert("Invalid station selection.");
      confirmBtn.disabled = false;
      confirmBtn.textContent = "Confirm Trip";
      return;
    }

    const fare = baseFare * (adults + children * 0.5) * (type === 'Round' ? 2 : 1);
    const summary = `
      <p><strong>From:</strong> ${from}</p>
      <p><strong>To:</strong> ${to}</p>
      <p><strong>Date:</strong> ${date}</p>
      <p><strong>Time:</strong> ${time}</p>
      <p><strong>Trip Type:</strong> ${type}</p>
      <p><strong>Passengers:</strong> ${adults} Adult(s), ${children} Child(ren)</p>
      <p><strong>Estimated Fare:</strong> BDT ${fare.toFixed(2)}</p>
    `;

    document.getElementById('summaryContent').innerHTML = summary;
    document.getElementById('tripOutput').classList.remove('hidden');

   const qrData = JSON.stringify({
  from,
  to,
  date,
  time,
  type,
  adults,
  children,
  fare: fare.toFixed(2)
});

    const qrContainer = document.getElementById('qrcode');
    qrContainer.innerHTML = "";
    new QRCode(qrContainer, {
  text: qrData,
  width: 150,
  height: 150,
  colorDark: "#006a4e",
  colorLight: "#ffffff",
  correctLevel: QRCode.CorrectLevel.H
});


    const token = localStorage.getItem("token");
    if (!token) {
      alert("You must be logged in to book a ticket.");
      confirmBtn.disabled = false;
      confirmBtn.textContent = "Confirm Trip";
      return;
    }

    try {
      // âœ… FIRST: fetch user info
      const userRes = await fetch("http://localhost:3000/api/auth/me", {
        headers: { Authorization: "Bearer " + token },
      });
      if (!userRes.ok) throw new Error("Failed to fetch user info");
      const user = await userRes.json();
      if (!user.email) throw new Error("User email not found");

      // âœ… THEN: book ticket using user.email
      const res = await fetch("http://localhost:3000/api/tickets/book", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token,
        },
        body: JSON.stringify({
          email: user.email,
          startPoint: from,
          endPoint: to,
          tripDate: date,
          tripTime: time,
          tripType: type,
          adultCount: adults,
          childCount: children,
        }),
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.msg || "Ticket booking failed");

      alert("âœ… Ticket successfully booked!");

      // âœ… Send trip summary email (if your backend sends it automatically)

      alert("ðŸ“§ A summary with QR code has been sent to your email!");

    } catch (err) {
      alert("âŒ Booking error: " + err.message);
    } finally {
      confirmBtn.disabled = false;
      confirmBtn.textContent = "Confirm Trip";
    }
  }

  async function payNow() {
  alert("ðŸ§¾ Redirecting to payment gateway...");
  try {
    const amount = 100; // you should calculate this dynamically based on fare
    const res = await fetch("http://localhost:3000/api/payment/initiate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ amount: amount, method: "bKash" }),
    });

    const data = await res.json();
    if (!res.ok || !data.redirectUrl) {
      throw new Error(data.msg || "Payment failed");
    }

    // âœ… Redirect to SSLCommerz Gateway
    window.location.href = data.redirectUrl;

  } catch (err) {
    alert("âŒ Payment error: " + err.message);
  }
}

    

  async function fetchUserData() {
    const token = localStorage.getItem('token');
    if (!token) {
      alert('Please login first.');
      window.location.href = 'login.html';
      return;
    }
    try {
      const res = await fetch('http://localhost:3000/api/auth/me', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (!res.ok) throw new Error('Failed to fetch user data');
      const user = await res.json();

      const usernameSpan = document.querySelector('span.username');
      if (usernameSpan) usernameSpan.textContent = user.username || 'User';

      const balanceSpan = document.querySelector('.text-yellow-200');
      if (balanceSpan) balanceSpan.textContent = 'BDT ' + (user.balance || 0).toFixed(2);

    } catch (err) {
      console.error(err);
      alert('Error loading user data. Please login again.');
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    fetchUserData();
    setMinDate();
    populateTimeOptions();
    document.getElementById('tripDate').addEventListener('change', populateTimeOptions);
  });
</script>

</body>
</html>
